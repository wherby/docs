<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Description for doradilla library.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Description for doradilla library.">
<link rel="shortcut icon" href="../../assets/images/favicon.png">
<title>Most awful code when use OO Â· Docs</title>
<link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../lib/prettify/prettify.css">
<script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../index.html" title="Docs" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Docs
</span>
<span class="md-header-nav__topic">
Most awful code when use OO
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/wherby/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
wherby/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../index.html" title="Docs" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../../index.html" title="Docs">
Docs
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/wherby/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
wherby/docs
</div>
</a>

</div>
<ul>
  <li><a href="../../singletruthprinciple.html" class="page">Single truth principle</a></li>
  <li><a href="../../database/index.html" class="page">Database Single truth principle</a>
  <ul>
    <li><a href="../../database/dbservice.html" class="page">DB service</a></li>
  </ul></li>
  <li><a href="../../fieldnull/index.html" class="page">Database null field error</a>
  <ul>
    <li><a href="../../fieldnull/code/index.html" class="page">Database define</a></li>
  </ul></li>
  <li><a href="../../engagement/index.html" class="page">Engagement entity add to database</a></li>
  <li><a href="../../slickqueryfailed/index.html" class="page">Slick query overflow</a></li>
  <li><a href="../../shadowquery/index.html" class="page">Shadow query</a></li>
  <li><a href="../../inconsistent/index.html" class="page">Inconsistent status</a></li>
  <li><a href="../../dailyjob/index.html" class="page">Daily schedule job</a></li>
  <li><a href="../../pac4j/index.html" class="page">Oauth2 client for Pac4j</a></li>
  <li><a href="../../nio/index.html" class="page">NIO and Akka-Http</a>
  <ul>
    <li><a href="../../nio/code/appacheMPMEvent.html" class="page">Apache MPM event</a></li>
    <li><a href="../../nio/code/scalableIOInJava.html" class="page">Scalable IO in Java</a></li>
  </ul></li>
  <li><a href="../../databasewithfile/index.html" class="page">Store file in database</a></li>
  <li><a href="../../flywayonmysql/index.html" class="page">Flyway clean failed on mysql8</a></li>
  <li><a href="../../iefrontend/index.html" class="page">IE issues for javascript</a></li>
  <li><a href="../../apicall/index.html" class="page">Api call failed</a></li>
  <li><a href="../../systemdesign/index.html" class="page">software architecture</a>
  <ul>
    <li><a href="../../systemdesign/sub/reality.html" class="page">What&rsquo;s reality of software development?</a></li>
    <li><a href="../../systemdesign/sub/issues.html" class="page">What&rsquo;re challenges of software development?</a></li>
    <li><a href="../../systemdesign/sub/reactive.html" class="page">The reactive manifesto</a></li>
    <li><a href="../../systemdesign/sub/doradilla.html" class="page">Doradilla design</a></li>
    <li><a href="../../systemdesign/sub/reference.html" class="page">References</a></li>
  </ul></li>
  <li><a href="../../poiexcel/index.html" class="page">Excel reader using POI</a></li>
  <li><a href="../../future/index.html" class="page">Future value</a></li>
  <li><a href="../../lockless/index.html" class="page">Lockless design</a></li>
  <li><a href="../../upgradeissue/index.html" class="page">Upgrade issue for authentication</a></li>
  <li><a href="../../dbinsert/index.html" class="page">DB bulk insert</a></li>
  <li><a href="../../react/index.html" class="page">React web render</a></li>
  <li><a href="../../oom/index.html" class="page">Out of memory for batch job</a></li>
  <li><a href="../../purefunction/index.html" class="page">Pure function design</a></li>
  <li><a href="../../codeissue/index.html" class="page">Code issue</a></li>
  <li><a href="../../timeout/index.html" class="page">Timeout errors and crash</a></li>
  <li><a href="../../presentationlayer/index.html" class="page">Refactor code for Excel output</a></li>
  <li><a href="../../coderefineusingfp/index.html" class="page">Refine code with function programming</a></li>
  <li><a href="../../traps/index.html" class="page">Traps in Scala</a></li>
  <li><a href="../../alloctMemFail/index.html" class="page">JVM allocate memory failed in docker</a></li>
  <li><a href="../../extractorDesign/index.html" class="page">How to structure a extractor process.</a></li>
  <li><a href="../../bugs/index.html" class="page">Bugs</a>
  <ul>
    <li><a href="../../bugs/unexpectedvalue/index.html" class="page">Unexpected value show up</a></li>
    <li><a href="../../bugs/pagecantget/index.html" class="page">Page can&rsquo;t retrieve</a></li>
    <li><a href="../../bugs/addfeature/index.html" class="page">Add features leads system fail</a></li>
    <li><a href="../../bugs/wrongnotification/index.html" class="page">Wrong notification</a></li>
    <li><a href="../../bugs/ieissue/index.html" class="page">Hosting issue for IE</a></li>
    <li><a href="../../bugs/numberAdd/index.html" class="page">Number add for round up</a></li>
    <li><a href="../../bugs/functionandval/index.html" class="page">Function and Val in code</a></li>
    <li><a href="../../bugs/excelBug/index.html" class="page">Excel formula issue</a></li>
    <li><a href="../../bugs/nginxDomain/index.html" class="page">nginx config for domain</a></li>
    <li><a href="../../bugs/regexsearch/index.html" class="page">Regex failed in frontend</a></li>
    <li><a href="../../bugs/mostAwfulCode/index.html" class="active page">Most awful code when use OO</a></li>
    <li><a href="../../bugs/java/index.html" class="page">Java related</a></li>
    <li><a href="../../bugs/loadissue/index.html" class="page">Load issue for valuation</a></li>
    <li><a href="../../bugs/pdfreader/index.html" class="page">Read PDF</a></li>
    <li><a href="../../bugs/redundantoperation/index.html" class="page">Redundant DB operation</a></li>
    <li><a href="../../bugs/statusUpdate/index.html" class="page">project status update issue</a></li>
    <li><a href="../../bugs/uicrash/index.html" class="page">UI crash</a></li>
    <li><a href="../../bugs/uitest/index.html" class="page">UI test</a></li>
    <li><a href="../../bugs/loadIssue2/index.html" class="page">Statistics load issue</a></li>
    <li><a href="../../bugs/initialCrash/index.html" class="page">Initial crash</a></li>
    <li><a href="../../bugs/debugcidr/index.html" class="page">Debug python processor</a></li>
    <li><a href="../../bugs/taskFailure/index.html" class="page">Schedule task</a></li>
    <li><a href="../../bugs/sqlfailed/index.html" class="page">MySQL query failed</a></li>
  </ul></li>
  <li><a href="../../codedesign/index.html" class="page">Code design</a>
  <ul>
    <li><a href="../../codedesign/notification/index.html" class="page">Notification desgin</a></li>
    <li><a href="../../codedesign/imsprocessor/index.html" class="page">IMS processor</a></li>
    <li><a href="../../codedesign/serviceImpl/index.html" class="page">Service design without interface</a></li>
    <li><a href="../../codedesign/cacheAPI/index.html" class="page">Cache API design</a></li>
    <li><a href="../../codedesign/processorDesignHandleMultiInput/index.html" class="page">Handle multi input</a></li>
    <li><a href="../../codedesign/deepcopy/index.html" class="page">Knowledge base establish with deep-copy</a></li>
  </ul></li>
  <li><a href="../../python/enclosure/index.html" class="page">Speed up python by remove enclosure</a></li>
  <li><a href="../../issues/index.html" class="page">Issues</a>
  <ul>
    <li><a href="../../issues/filereader/index.html" class="page">Read Excel will modify</a></li>
    <li><a href="../../issues/exceptionhandle/index.html" class="page">Handle verification</a></li>
    <li><a href="../../issues/codeStyle/inde.html" class="page">Code not easy to understand</a></li>
    <li><a href="../../issues/playui/index.html" class="page">Play UI cache issue</a></li>
    <li><a href="../../issues/uidisplay/index.html" class="page">Competitive programming display issue</a></li>
    <li><a href="../../issues/warningmessage/index.html" class="page">Suppress insecurerequestwarning</a></li>
  </ul></li>
  <li><a href="../../design/index.html" class="page">Design</a>
  <ul>
    <li><a href="../../design/dependency/index.html" class="page">Dependency</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../bugs/mostAwfulCode/index.html#most-awful-code-when-use-oo" class="header">Most awful code when use OO</a>
  <ul>
    <li><a href="../../bugs/mostAwfulCode/index.html#code" class="header">code</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../bugs/mostAwfulCode/index.html#most-awful-code-when-use-oo" class="header">Most awful code when use OO</a>
  <ul>
    <li><a href="../../bugs/mostAwfulCode/index.html#code" class="header">code</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#most-awful-code-when-use-oo" name="most-awful-code-when-use-oo" class="anchor"><span class="anchor-link"></span></a>Most awful code when use OO</h1>
<h2><a href="#code" name="code" class="anchor"><span class="anchor-link"></span></a>code</h2>
<dl>
  <dt>Controller</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/bugs/mostAwfulCode/code/FundEngagementReportTypeSelectionController.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">maybeFund
  .map(fund =&gt; {
    val fundStrategy: Option[FundReportStrategy] = {
      fundReportStrategyFactory.getFundReportStrategy(fund.fundAdmin)
    }
    fundStrategy match {
      case Some(strategy) =&gt;
        strategy
          .processFundReport(request, disabledAfterYEReports)(fundEngagement, fund)
      case None =&gt; {
        val processResult: Result =
          FundAdminName.withNameWithDefault(fund.fundAdmin) match {
            case HSBC_IMS =&gt; {
              processIMSFiles(request, fundEngagement, fund, disabledAfterYEReports)
            }</code></pre></dd>
  <dt>FundReportStrategyFactory</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/bugs/mostAwfulCode/code/FundReportStrategyFactory.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package com.pwc.ds.awm.strategy.fundadmin

trait FundReportStrategyFactory {

  def getFundReportStrategy(name: String): Option[FundReportStrategy]
}</code></pre></dd>
  <dt>FundReportStrategy</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/bugs/mostAwfulCode/code/FundReportStrategy.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">import java.io.File
import scala.collection.Map

class FundReportStrategyBase @Inject() (
                                         doraServer: DoraServer,
                                         securityItemRead: SecurityItemRead,
                                         fundEngagementReportTypeSelectionRead: FundEngagementReportTypeSelectionRead,
                                         fundEngagementReportTypeSelectionWrite: FundEngagementReportTypeSelectionWrite
                                       ) extends FundReportStrategy {

  var disabledAfterYEReports: Map[String, Boolean] = Map[String, Boolean]()

  override def processFundReport(
                                  request: Request[MultipartFormData[Files.TemporaryFile]],
                                  disabledAfterYEReports: Map[String, Boolean]
                                )(implicit fundEngagement: FundEngagementData, fund: Fund): Result = {
    implicit val userEmail: String = request.session.get(&quot;email&quot;).getOrElse(&quot;&quot;)
    this.disabledAfterYEReports = disabledAfterYEReports
    request.body
      .file(&quot;file&quot;)
      .map(file =&gt; {
        FileType.withNameOpt(file.contentType.getOrElse(&quot;&quot;)) match {
          case Some(contentType) =&gt;
            var fileContentType = contentType

            // This below handle some cases where uploading csv from window gives excel contentType due to the Window registry settings.
            if (
              (fileContentType == FileType.XLS || fileContentType == FileType.XLSX) &amp;&amp; FilenameUtils
                .getExtension(file.filename)
                .toLowerCase == &quot;csv&quot;
            ) {
              fileContentType = FileType.TextCSV
            }

            processFile(file.ref.toFile, file.filename, fileContentType, disabledAfterYEReports)  //No 3.

          case None =&gt;
            encapErrorResponse(
              UnprocessableEntity,
              ExtractionErrorCode.UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION
            )
        }
      })
      .getOrElse(
        encapErrorResponse(
          UnprocessableEntity,
          ExtractionErrorCode.UNRECOGNISED_ERROR
        )
      )
  }



  def processFile(
                   file: File,
                   fileName: String,
                   fileType: FileType,
                   disabledAfterYEReports: Map[String, Boolean]
                 )(implicit
                   fundEngagement: FundEngagementData,
                   fund: Fund,
                   userEmail: String
                 ): Result = encapErrorResponse(
    UnprocessableEntity,
    ExtractionErrorCode.UNRECOGNISED_ERROR
  )



  def processExcelFile(
                        filePath: String,
                        contentType: String,
                        disabledAfterYEReports: Map[String, Boolean]
                      )(implicit
                        fundEngagement: FundEngagementData,
                        fund: Fund,
                        userEmail: String
                      ): Result = {
    val workbook = GeneralExcelExtractor
      .extract(filePath, contentType)
      .getOrElse(
        throw ExtractionTabError(None, ExtractionErrorCode.UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION) // Why the UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION throw??
      )

    val periodStart = date2UTCLocalDate(fund.auditPeriodBegin)
    val periodEnd   = date2UTCLocalDate(fund.auditPeriodEnd)

    val sheetIterator = workbook.sheetIterator()

    var updatedTab         = ListBuffer[String]()
    var successWithWarning = new ListBuffer[WarningTabStatus]()
    var errorList          = new ListBuffer[ExtractionTabError]()

    while (sheetIterator.hasNext) {
      val sheet = sheetIterator.next()
      getTabProcessorExec(sheet, disabledAfterYEReports) match {
        case Success(value) =&gt;
          value match {
            case (tabs, warning) =&gt;
              if (tabs.nonEmpty) updatedTab ++= tabs
              if (warning.nonEmpty) successWithWarning ++= warning
            case _ =&gt;
          }
        case Failure(e) =&gt;
          e match {
            case fErr: ExtractionError =&gt;
              errorList += ExtractionTabError(None, fErr.errorCode)
            case eErr: ExtractionTabError =&gt;
              SafeLogger.logStringError(
                Logger,
                s&quot;Extraction failed for fund engagement ${fundEngagement.id}&quot;,
                eErr
              )
              errorList += eErr
            case eErr: Exception =&gt;
              SafeLogger.logStringError(
                Logger,
                s&quot;Extraction failed for fund engagement ${fundEngagement.id}&quot;,
                eErr
              )
              errorList += ExtractionTabError(None, ExtractionErrorCode.UNRECOGNISED_ERROR)
          }
      }
    }

    if (successWithWarning.nonEmpty || errorList.nonEmpty || updatedTab.nonEmpty) {
      encapExtractionResult(
        massageWarning(updatedTab, successWithWarning.toList),
        fund.name,
        periodStart,
        periodEnd,
        massageError(updatedTab, errorList.toList)
      )
    } else {
      SafeLogger.logStringError(
        Logger,
        s&quot;Extraction failed for fund engagement ${fundEngagement.id}&quot;,
        ExtractionException(&quot;No result &amp; error&quot;)
      )
      encapErrorResponse(
        UnprocessableEntity,
        ExtractionErrorCode.UNRECOGNISED_ERROR
      )
    }
  }

  def getExcelReportProcessorClass(
                                    sheet: Sheet,
                                    fundName: String,
                                    fundEngagementId: String
                                  ): Option[String] = None

  def ruleMatchProcess(
                        reportMap: Map[EGATab, (String, Seq[(String, Seq[MatchRule])])],
                        fundEngagementId: String,
                        matchLogic: (MatchRule, EGATab) =&gt; Boolean
                      ): Option[String] = {
    val selectedTypeId = getSelectedReportTypeId(fundEngagementId)
    reportMap.foreach { case (reportType, config) =&gt;
      if (
        Option(config._2).isDefined &amp;&amp; Option(config._2).nonEmpty &amp;&amp; selectedTypeId.contains(
          config._1
        )
      )
        config._2.foreach(processor_rule =&gt; {
          if (processor_rule._2.exists(rule =&gt; matchLogic(rule, reportType)))
            return Some(processor_rule._1)
        })
    }
    None
  }</code></pre></dd>
  <dt>BNPFundReportStrategy</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/bugs/mostAwfulCode/code/BNPFundReportStrategy.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">import java.io.File
import scala.collection.Map

override def processFile(
                          file: File,
                          fileName: String,
                          fileType: FileType,
                          disabledAfterYEReports: Map[String, Boolean]
                        )(implicit
                          fundEngagement: FundEngagementData,
                          fund: Fund,
                          userEmail: String
                        ): Result = {
  fileType match {
    case contentType if contentType == FileType.XLSX || contentType == FileType.XLS =&gt;
      processExcelFile(file.getPath, contentType.toString, disabledAfterYEReports)
    case _ =&gt;
      encapErrorResponse(
        UnprocessableEntity,
        ExtractionErrorCode.UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION
      )
  }
}

override def getExcelReportProcessorClass(
                                           sheet: Sheet,
                                           fundName: String,
                                           fundEngagementId: String
                                         ): Option[String] = {

  ruleMatchProcess(
    map,
    fundEngagementId,
    (rule: MatchRule, reportType: EGATab) =&gt;
      rule match {
        // check fund name and worksheet name
        case ExcelMatchRule(name, rnameCell, None, (-1, -1), None, _) =&gt;
          isReportNameMatch(name, sheet, rnameCell)
        // checks fund name but no checking on worksheet name
        case ExcelMatchRule(name, rnameCell, None, fundCell, None, _) =&gt;
          if (isReportNameMatch(name, sheet, rnameCell))
            isFundNameMatch(fundName, sheet, fundCell, reportType)
          else false
        // check worksheet name but no checking on fund name
        case ExcelMatchRule(name, rnameCell, Some(sheetRegex), (-1, -1), None, _) =&gt;
          isReportNameMatch(name, sheet, rnameCell) &amp;&amp; regexMatch(sheetRegex, sheet.getSheetName)
        // check both fund name and worksheet name
        case ExcelMatchRule(name, rnameCell, Some(sheetRegex), fundCell, None, _) =&gt;
          if (
            isReportNameMatch(name, sheet, rnameCell) &amp;&amp; regexMatch(
              sheetRegex,
              sheet.getSheetName
            )
          )
            isFundNameMatch(fundName, sheet, fundCell, reportType)
          else false
        // check table header &amp; sheet name
        case ExcelMatchRule(
        _,
        (-1, -1),
        Some(sheetRegex),
        (-1, -1),
        Some(headerRowRule),
        headerRowRange
        ) =&gt;
          regexMatch(sheetRegex, sheet.getSheetName) &amp;&amp; isHeaderRowMatch(
            sheet,
            headerRowRule,
            headerRowRange
          )
        // check table header
        case ExcelMatchRule(_, (-1, -1), None, (-1, -1), Some(headerRowRule), headerRowRange) =&gt;
          isHeaderRowMatch(sheet, headerRowRule, headerRowRange)
        case _ =&gt; false
      }
  )
}</code></pre></dd>
</dl>
<p>When encounter error, we want to debug issue goes to Controller</p>
<pre class="prettyprint"><code class="language-scala">    fundStrategy match {
      case Some(strategy) =&gt;
        strategy
          .processFundReport(request, disabledAfterYEReports)(fundEngagement, fund)
</code></pre>
<p>But the processFundReport is an interface</p>
<pre class="prettyprint"><code class="language-scala">trait FundReportStrategyFactory {

  def getFundReportStrategy(name: String): Option[FundReportStrategy]
}
</code></pre>
<p>Which means you can&rsquo;t use IDE tool to goto the right code section, when you go with debug tool which will go to FundReportStrategy File</p>
<pre class="prettyprint"><code class="language-scala">override def processFundReport(
                                  request: Request[MultipartFormData[Files.TemporaryFile]],
                                  disabledAfterYEReports: Map[String, Boolean]
                                )(implicit fundEngagement: FundEngagementData, fund: Fund): Result = {
    implicit val userEmail: String = request.session.get(&quot;email&quot;).getOrElse(&quot;&quot;)
    this.disabledAfterYEReports = disabledAfterYEReports
    request.body
      .file(&quot;file&quot;)
      .map(file =&gt; {
        FileType.withNameOpt(file.contentType.getOrElse(&quot;&quot;)) match {
          case Some(contentType) =&gt;
            var fileContentType = contentType

            // This below handle some cases where uploading csv from window gives excel contentType due to the Window registry settings.
            if (
              (fileContentType == FileType.XLS || fileContentType == FileType.XLSX) &amp;&amp; FilenameUtils
                .getExtension(file.filename)
                .toLowerCase == &quot;csv&quot;
            ) {
              fileContentType = FileType.TextCSV
            }

            processFile(file.ref.toFile, file.filename, fileContentType, disabledAfterYEReports)  //No 3. Ok, we will go to here
</code></pre>
<p>OK, we trace &ldquo;processFile&rdquo;, but the function is still another interface:</p>
<pre class="prettyprint"><code class="language-scala">  def processFile(
      file: File,
      fileName: String,
      fileType: FileType,
      disabledAfterYEReports: Map[String, Boolean]
  )(implicit
      fundEngagement: FundEngagementData,
      fund: Fund,
      userEmail: String
  ): Result = encapErrorResponse(
    UnprocessableEntity,
    ExtractionErrorCode.UNRECOGNISED_ERROR
  )
</code></pre>
<p>go with the same debugger, we will go to BNPFundReportStrategy file </p>
<pre class="prettyprint"><code class="language-scala">override def processFile(
                          file: File,
                          fileName: String,
                          fileType: FileType,
                          disabledAfterYEReports: Map[String, Boolean]
                        )(implicit
                          fundEngagement: FundEngagementData,
                          fund: Fund,
                          userEmail: String
                        ): Result = {
  fileType match {
    case contentType if contentType == FileType.XLSX || contentType == FileType.XLS =&gt;
      processExcelFile(file.getPath, contentType.toString, disabledAfterYEReports)
    case _ =&gt;
      encapErrorResponse(
        UnprocessableEntity,
        ExtractionErrorCode.UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION
      )
  }
}
</code></pre>
<p>And &ldquo;processExcelFile&rdquo; will lead you back to FundReportStrategy</p>
<pre class="prettyprint"><code class="language-scala">def processExcelFile(
                        filePath: String,
                        contentType: String,
                        disabledAfterYEReports: Map[String, Boolean]
                      )(implicit
                        fundEngagement: FundEngagementData,
                        fund: Fund,
                        userEmail: String
                      ): Result = {
    val workbook = GeneralExcelExtractor
      .extract(filePath, contentType)
      .getOrElse(
        throw ExtractionTabError(None, ExtractionErrorCode.UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION) // Why the UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION throw??
      )

    val periodStart = date2UTCLocalDate(fund.auditPeriodBegin)
    val periodEnd   = date2UTCLocalDate(fund.auditPeriodEnd)

    val sheetIterator = workbook.sheetIterator()

    var updatedTab         = ListBuffer[String]()
    var successWithWarning = new ListBuffer[WarningTabStatus]()
    var errorList          = new ListBuffer[ExtractionTabError]()

    while (sheetIterator.hasNext) {
      val sheet = sheetIterator.next()
      getTabProcessorExec(sheet, disabledAfterYEReports) match {
        case Success(value) =&gt;
          value match {
            case (tabs, warning) =&gt;
              if (tabs.nonEmpty) updatedTab ++= tabs
              if (warning.nonEmpty) successWithWarning ++= warning
            case _ =&gt;
          }
        case Failure(e) =&gt;
          e match {
            case fErr: ExtractionError =&gt;
              errorList += ExtractionTabError(None, fErr.errorCode)
            case eErr: ExtractionTabError =&gt;
              SafeLogger.logStringError(
                Logger,
                s&quot;Extraction failed for fund engagement ${fundEngagement.id}&quot;,
                eErr
              )
</code></pre>
<p>Then &ldquo;getTabProcessorExec&rdquo; will leads you to the function getTabProcessorExec in same file:</p>
<pre class="prettyprint"><code class="language-scala">  def getTabProcessorExec(sheet: Sheet, disabledAfterYEReports: Map[String, Boolean])(implicit
      fundEngagement: FundEngagementData,
      fund: Fund,
      userEmail: String
  ): Try[(Seq[String], Seq[WarningTabStatus])] = Try {
    val processorClass =
      getExcelReportProcessorClass(sheet, fund.name, fundEngagement.id).getOrElse(
        throw ExtractionTabError(None, ExtractionErrorCode.UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION)
      )
</code></pre>
<p>The most interesting thing happens, when the getExcelReportProcessorClass get None, then throw wrong exceptions. HAHAHA~~~</p>
<pre class="prettyprint"><code class="language-scala">getOrElse(
        throw ExtractionTabError(None, ExtractionErrorCode.UNSUPPORTED_REPORT_TYPE_FILE_EXTENSION)
      )
</code></pre>
<p>Ok, we ignore the issue and go to the implementation. Well, &ldquo;getExcelReportProcessorClass&rdquo; also an interface.</p>
<pre class="prettyprint"><code class="language-scala">  def getExcelReportProcessorClass(
      sheet: Sheet,
      fundName: String,
      fundEngagementId: String
  ): Option[String] = None
</code></pre>
<p>The implementation of getExcelReportProcessorClass will goes to BNPFundReportStrategy file</p>
<pre class="prettyprint"><code class="language-scala"> override def getExcelReportProcessorClass(
      sheet: Sheet,
      fundName: String,
      fundEngagementId: String
  ): Option[String] = {

    ruleMatchProcess(
      map,
      fundEngagementId,
      (rule: MatchRule, reportType: EGATab) =&gt;
        rule match {
          // check fund name and worksheet name
          case ExcelMatchRule(name, rnameCell, None, (-1, -1), None, _) =&gt;
            isReportNameMatch(name, sheet, rnameCell)
          // checks fund name but no checking on worksheet name
          case ExcelMatchRule(name, rnameCell, None, fundCell, None, _) =&gt;
            if (isReportNameMatch(name, sheet, rnameCell))
              isFundNameMatch(fundName, sheet, fundCell, reportType)
            else false
          // check worksheet name but no checking on fund name
          case ExcelMatchRule(name, rnameCell, Some(sheetRegex), (-1, -1), None, _) =&gt;
            isReportNameMatch(name, sheet, rnameCell) &amp;&amp; regexMatch(sheetRegex, sheet.getSheetName)
          // check both fund name and worksheet name
          case ExcelMatchRule(name, rnameCell, Some(sheetRegex), fundCell, None, _) =&gt;
            if (
              isReportNameMatch(name, sheet, rnameCell) &amp;&amp; regexMatch(
                sheetRegex,
                sheet.getSheetName
              )
            )
              isFundNameMatch(fundName, sheet, fundCell, reportType)
            else false
          // check table header &amp; sheet name
          case ExcelMatchRule(
                _,
                (-1, -1),
                Some(sheetRegex),
                (-1, -1),
                Some(headerRowRule),
                headerRowRange
              ) =&gt;
            regexMatch(sheetRegex, sheet.getSheetName) &amp;&amp; isHeaderRowMatch(
              sheet,
              headerRowRule,
              headerRowRange
            )
          // check table header
          case ExcelMatchRule(_, (-1, -1), None, (-1, -1), Some(headerRowRule), headerRowRange) =&gt;
            isHeaderRowMatch(sheet, headerRowRule, headerRowRange)
          case _ =&gt; false
        }
    )
  }
</code></pre>
<p>Here is almost interesting things, for &ldquo;ruleMatchProcess&rdquo; we need to go back &ldquo;FundReportStrategy&rdquo; file</p>
<pre class="prettyprint"><code class="language-scala">  def ruleMatchProcess(
      reportMap: Map[EGATab, (String, Seq[(String, Seq[MatchRule])])],
      fundEngagementId: String,
      matchLogic: (MatchRule, EGATab) =&gt; Boolean
  ): Option[String] = {
    val selectedTypeId = getSelectedReportTypeId(fundEngagementId)
    reportMap.foreach { case (reportType, config) =&gt;
      if (
        Option(config._2).isDefined &amp;&amp; Option(config._2).nonEmpty &amp;&amp; selectedTypeId.contains(
          config._1
        )
      )
        config._2.foreach(processor_rule =&gt; {
          if (processor_rule._2.exists(rule =&gt; matchLogic(rule, reportType)))
            return Some(processor_rule._1)
        })
    }
    None
  }
</code></pre>
<p>The function has three parameters, that&rsquo;s matchLogic is the function return by BNPFundReportStrategy.</p>
<pre class="prettyprint"><code class="language-scala">(rule: MatchRule, reportType: EGATab) =&gt;
        rule match {
          // check fund name and worksheet name
          case ExcelMatchRule(name, rnameCell, None, (-1, -1), None, _) =&gt;
            isReportNameMatch(name, sheet, rnameCell)
          // checks fund name but no checking on worksheet name
          case ExcelMatchRule(name, rnameCell, None, fundCell, None, _) =&gt;
            if (isReportNameMatch(name, sheet, rnameCell))
              isFundNameMatch(fundName, sheet, fundCell, reportType)
            else false
          // check worksheet name but no checking on fund name
          case ExcelMatchRule(name, rnameCell, Some(sheetRegex), (-1, -1), None, _) =&gt;
            isReportNameMatch(name, sheet, rnameCell) &amp;&amp; regexMatch(sheetRegex, sheet.getSheetName)
          // check both fund name and worksheet name
          case ExcelMatchRule(name, rnameCell, Some(sheetRegex), fundCell, None, _) =&gt;
            if (
              isReportNameMatch(name, sheet, rnameCell) &amp;&amp; regexMatch(
                sheetRegex,
                sheet.getSheetName
              )
            )
              isFundNameMatch(fundName, sheet, fundCell, reportType)
            else false
          // check table header &amp; sheet name
          case ExcelMatchRule(
                _,
                (-1, -1),
                Some(sheetRegex),
                (-1, -1),
                Some(headerRowRule),
                headerRowRange
              ) =&gt;
            regexMatch(sheetRegex, sheet.getSheetName) &amp;&amp; isHeaderRowMatch(
              sheet,
              headerRowRule,
              headerRowRange
            )
          // check table header
          case ExcelMatchRule(_, (-1, -1), None, (-1, -1), Some(headerRowRule), headerRowRange) =&gt;
            isHeaderRowMatch(sheet, headerRowRule, headerRowRange)
          case _ =&gt; false
        }
</code></pre>
<p>Well, with the shitty code logic, what&rsquo;s matchLogic will be in the function ruleMatchProcess, I think nobody can find out without real time debugger.</p>
<p>Well, if you want to say you can use debugger to check the running time value, then you are beyond naive, the value in debugger is as below:</p>
<p><img src="pics/matchLogic.png" alt="matchLogic" /></p>
<p>This is a perfect example of follow OO design and write code which can&rsquo;t be debugged.</p>
<pre class="prettyprint"><code class="language-markdown">    1. Use the interface, hardy trace the right implemetation

    2. Use Factory mode, also no easy trace by another person who is not the code writer.

    3. The logic jump from implementation and interface multiple times

    4. The parameter configuration is by logic spaghetti.
        And the logic depends on multi input format. 
</code></pre>
</div>
<div>
<a href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/bugs/mostAwfulCode/index.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LVLRXPE9ZP"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-LVLRXPE9ZP');
</script>
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../bugs/regexsearch/index.html" title="Regex failed in frontend" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Regex failed in frontend
</span>
</div>
</a>
<a href="../../bugs/java/index.html" title="Java related" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Java related
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/wherby" class="md-footer-social__link fa fa-github"></a><a href="https://wherby.github.io" class="md-footer-social__link fa fa-globe"></a>
</div>

</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../."}})</script>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
