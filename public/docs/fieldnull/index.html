<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Description for doradilla library.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Description for doradilla library.">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Database null field error Â· Docs</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Docs" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Docs
</span>
<span class="md-header-nav__topic">
Database null field error
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/wherby/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
wherby/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Docs" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="Docs">
Docs
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/wherby/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
wherby/docs
</div>
</a>

</div>
<ul>
  <li><a href="../singletruthprinciple.html" class="page">Single truth principle</a></li>
  <li><a href="../database/index.html" class="page">Database Single truth principle</a>
  <ul>
    <li><a href="../database/dbservice.html" class="page">DB service</a></li>
  </ul></li>
  <li><a href="../fieldnull/index.html" class="active page">Database null field error</a>
  <ul>
    <li><a href="../fieldnull/code/index.html" class="page">Database define</a></li>
  </ul></li>
  <li><a href="../engagement/index.html" class="page">Engagement entity add to database</a></li>
  <li><a href="../slickqueryfailed/index.html" class="page">Slick query overflow</a></li>
  <li><a href="../shadowquery/index.html" class="page">Shadow query</a></li>
  <li><a href="../inconsistent/index.html" class="page">Inconsistent status</a></li>
  <li><a href="../dailyjob/index.html" class="page">Daily schedule job</a></li>
  <li><a href="../pac4j/index.html" class="page">Oauth2 client for Pac4j</a></li>
  <li><a href="../nio/index.html" class="page">NIO and Akka-Http</a>
  <ul>
    <li><a href="../nio/code/appacheMPMEvent.html" class="page">Apache MPM event</a></li>
    <li><a href="../nio/code/scalableIOInJava.html" class="page">Scalable IO in Java</a></li>
  </ul></li>
  <li><a href="../databasewithfile/index.html" class="page">Store file in database</a></li>
  <li><a href="../flywayonmysql/index.html" class="page">Flyway clean failed on mysql8</a></li>
  <li><a href="../iefrontend/index.html" class="page">IE issues for javascript</a></li>
  <li><a href="../apicall/index.html" class="page">Api call failed</a></li>
  <li><a href="../systemdesign/index.html" class="page">software architecture</a>
  <ul>
    <li><a href="../systemdesign/sub/reality.html" class="page">What&rsquo;s reality of software development?</a></li>
    <li><a href="../systemdesign/sub/issues.html" class="page">What&rsquo;re challenges of software development?</a></li>
    <li><a href="../systemdesign/sub/reactive.html" class="page">The reactive manifesto</a></li>
    <li><a href="../systemdesign/sub/doradilla.html" class="page">Doradilla design</a></li>
    <li><a href="../systemdesign/sub/reference.html" class="page">References</a></li>
  </ul></li>
  <li><a href="../poiexcel/index.html" class="page">Excel reader using POI</a></li>
  <li><a href="../future/index.html" class="page">Future value</a></li>
  <li><a href="../lockless/index.html" class="page">Lockless design</a></li>
  <li><a href="../upgradeissue/index.html" class="page">Upgrade issue for authentication</a></li>
  <li><a href="../dbinsert/index.html" class="page">DB bulk insert</a></li>
  <li><a href="../react/index.html" class="page">React web render</a></li>
  <li><a href="../oom/index.html" class="page">Out of memory for batch job</a></li>
  <li><a href="../purefunction/index.html" class="page">Pure function design</a></li>
  <li><a href="../codeissue/index.html" class="page">Code issue</a></li>
  <li><a href="../timeout/index.html" class="page">Timeout errors and crash</a></li>
  <li><a href="../presentationlayer/index.html" class="page">Refactor code for Excel output</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../fieldnull/index.html#database-null-field-error" class="header">Database null field error</a>
  <ul>
    <li><a href="../fieldnull/index.html#user-bug-report" class="header">User bug report</a></li>
    <li><a href="../fieldnull/index.html#database-check" class="header">Database check</a></li>
    <li><a href="../fieldnull/index.html#database-define" class="header">Database define</a></li>
    <li><a href="../fieldnull/index.html#code-check" class="header">Code check</a></li>
    <li><a href="../fieldnull/index.html#after-fix" class="header">After fix</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../fieldnull/index.html#database-null-field-error" class="header">Database null field error</a>
  <ul>
    <li><a href="../fieldnull/index.html#user-bug-report" class="header">User bug report</a></li>
    <li><a href="../fieldnull/index.html#database-check" class="header">Database check</a></li>
    <li><a href="../fieldnull/index.html#database-define" class="header">Database define</a></li>
    <li><a href="../fieldnull/index.html#code-check" class="header">Code check</a></li>
    <li><a href="../fieldnull/index.html#after-fix" class="header">After fix</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#database-null-field-error" name="database-null-field-error" class="anchor"><span class="anchor-link"></span></a>Database null field error</h1>
<h2><a href="#user-bug-report" name="user-bug-report" class="anchor"><span class="anchor-link"></span></a>User bug report</h2>
<p>User report error when they want to define report types for fund in engagemnt:</p>
<p><img src="./userreport.png" alt="User report" /></p>
<p>When check the request in the network:</p>
<p><img src="./requestpayload.png" alt="Request" /></p>
<p>Compare with valid request in network:</p>
<p><img src="./validRequest.png" alt="Valid request" /></p>
<p>We will find that id is missing in the payload.</p>
<h2><a href="#database-check" name="database-check" class="anchor"><span class="anchor-link"></span></a>Database check</h2>
<p>Check the database:</p>
<p><img src="./databasequery.png" alt="Database query" /></p>
<p>It seems the fund_admin_id field is null, we fix this issue, then user could define report types now. But we check the production database, we will find the field will be set to null by application:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/sql.txt" target="_blank" title="Go to snippet source"></a><code class="language-txt"><br/>4:20:13 PM: mysql&gt; SELECT id,fund_admin_id,fund_admin FROM awm.funds;
+--------------------------------------+---------------+-----------------+
| id                                   | fund_admin_id | fund_admin      |
+--------------------------------------+---------------+-----------------+
| 02635de9-97d8-4520-90f3-68a53e3d6518 | 1             | HSBC IMS        |
| 03361d5c-531e-411f-8a57-e02eaffa81e7 | 1             | HSBC IMS        |


| 8be5db7b-3358-4e3d-a572-839f2f765ed9 | 1             | HSBC IMS        |
| 918bb23a-c5ff-4a91-a822-bf8f8416fadd | 1             | HSBC IMS        |
| 930131cb-9c91-44b0-88e7-12460949dcae | 1             | HSBC IMS        |
| 961c5a46-9a87-4084-ac0d-408c436522d8 | 1             | HSBC IMS        |
| a6e44dc6-b72e-4b23-8d1d-b885c8561e83 | 2             | HSBC MultiFonds |
| b1109ece-7686-4efb-93d6-81e00356c736 | 1             | HSBC IMS        |
| b8c1cb44-c60e-482c-9b7f-67abc6165a75 | 1             | HSBC IMS        |    ********
| be3de937-5c8a-45d7-8619-047a50785430 | 1             | HSBC IMS        |
| cb4c2be3-78b4-4edb-b08f-11b66fb4ee1e | 1             | HSBC IMS        |
| d2bbb0ec-50c1-44b6-8039-686daf8e137f | 1             | HSBC IMS        |
| ebbae85a-52f1-4445-9dbb-79e6d2bd8db1 | 1             | HSBC IMS        |
| f872f26e-21fe-4d12-b23e-baa0635d8ebf | 3             | HSBC Geneva     |
| f9c9eb38-7a1c-43c0-9678-c4562594449b | 1             | HSBC IMS        |
| fb488f25-d2e8-47d2-9090-6807c9960c01 | 1             | HSBC IMS        |
| fbec119f-7e68-4cbc-905b-b40db35f0a2f | 1             | HSBC IMS        |
+--------------------------------------+---------------+-----------------+
43 rows in set (0.00 sec) 



5:38:27 PM: mysql&gt; SELECT id,fund_admin_id,fund_admin FROM awm.funds; 
+--------------------------------------+---------------+-----------------+
| id                                   | fund_admin_id | fund_admin      |
+--------------------------------------+---------------+-----------------+
| 02635de9-97d8-4520-90f3-68a53e3d6518 | 1             | HSBC IMS        |
| 03361d5c-531e-411f-8a57-e02eaffa81e7 | 1             | HSBC IMS        |
| 049d9aa4-2822-4bcd-8ec7-1b6bef3cd628 | 1             | HSBC IMS        |
| 0a1938df-a03a-45c8-8c3a-86e4bd52d92c | 1             | HSBC IMS        |


| 961c5a46-9a87-4084-ac0d-408c436522d8 | 1             | HSBC IMS        |
| a6e44dc6-b72e-4b23-8d1d-b885c8561e83 | 2             | HSBC MultiFonds |
| b1109ece-7686-4efb-93d6-81e00356c736 | 1             | HSBC IMS        |
| b42ab859-ff5a-4fe0-b283-fe0c98c88392 | 1             | HSBC IMS        |
| b8c1cb44-c60e-482c-9b7f-67abc6165a75 | NULL          | HSBC IMS        |   ********
| be3de937-5c8a-45d7-8619-047a50785430 | 1             | HSBC IMS        |
| cb4c2be3-78b4-4edb-b08f-11b66fb4ee1e | 1             | HSBC IMS        |
| d2bbb0ec-50c1-44b6-8039-686daf8e137f | 1             | HSBC IMS        |
| ebbae85a-52f1-4445-9dbb-79e6d2bd8db1 | 1             | HSBC IMS        |
| f872f26e-21fe-4d12-b23e-baa0635d8ebf | 3             | HSBC Geneva     |
| f9c9eb38-7a1c-43c0-9678-c4562594449b | 1             | HSBC IMS        |
| fb488f25-d2e8-47d2-9090-6807c9960c01 | 1             | HSBC IMS        |
| fbec119f-7e68-4cbc-905b-b40db35f0a2f | 1             | HSBC IMS        |
+--------------------------------------+---------------+-----------------+
44 rows in set (0.00 sec) 
</code></pre><h2><a href="#database-define" name="database-define" class="anchor"><span class="anchor-link"></span></a>Database define</h2>
<p>The database define as below:</p>
<dl>
  <dt>Fund</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/code/fund.sql" target="_blank" title="Go to snippet source"></a><code class="language-sql">create table `funds`(
   `id` varchar(128) NOT NULL,
   `name` VARCHAR(128) not null,
    fund_admin_id varchar(128) null,
   `fund_type` VARCHAR(128) not null,
   `legal_structure` VARCHAR(128) not null,
   `base_currency` VARCHAR(128) not null,
   `audit_period_begin` TIMESTAMP not null,
   `audit_period_end` TIMESTAMP not null,
   `fund_admin` VARCHAR(128) not null,
   `admin_code` VARCHAR(128) NULL,
   `createby` VARCHAR(128) NULL,
   `createdatetime`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP NULL,
   `modifyby` VARCHAR(128) NULL,
   `modifydatetime`  TIMESTAMP  NULL,
   PRIMARY KEY (`id`)
)</code></pre></dd>
  <dt>FundAdmin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/code/fundadmin.sql" target="_blank" title="Go to snippet source"></a><code class="language-sql">create table `fund_admin`(
    `id` varchar(128) NOT NULL,
    `name` varchar(128) NOT NULL,
    PRIMARY KEY (`id`)
)</code></pre></dd>
</dl>
<h2><a href="#code-check" name="code-check" class="anchor"><span class="anchor-link"></span></a>Code check</h2>
<p>The field fund_admin_id in fund table is queried from fund admin table.</p>
<dl>
  <dt>Create fund</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/code/create.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def create(fund: Fund, engagementId:String): Future[Int] = {
  engagementDAO.lookup(engagementId).flatMap(maybeEngagement =&gt; {
    maybeEngagement match {
      case engagement =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fund.fundAdminId = Some(fundAdmin.id)
              fundsDAO.create(fund, engagementId)
            }
            case _ =&gt;{
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        }).flatMap(resFund =&gt; {
          var fundEngagement = new FundEngagementData(randomUUID().toString, engagementId, resFund.id, None, resFund.createby, Some(new Timestamp(DateTime.now.getMillis)))
          fundEngagementDAO.create(fundEngagement)
        })
      }
      case _ =&gt; {
        throw new Exception(s&quot;engagement with this Id doesn&#39;t exist&quot;)
      }
    }
  })
}
</code></pre></dd>
  <dt>Update fund</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/code/update.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def update(fund: Fund): Future[Int] = {
  fundsDAO.lookup(fund.id).flatMap(maybeFund =&gt; {
    maybeFund match {

      //if fundAdmin changed, should update fund admin id and remove fund selection types
      case Some(existingFund) if(existingFund.fundAdmin != fund.fundAdmin) =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fund.fundAdminId = Some(fundAdmin.id)
              fundsDAO.update(fund).flatMap(updateResult =&gt; {
                fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
                  fundEngagementReportTypeSelectionDAO.deleteByEngagementIds(engagements.map(_.id))
                })
              })
            }
            case _ =&gt;{
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        })
      }
      //if fund audit period or accurency changed, should clear uploaded reports and ega.
      case Some(exisitingFund) if(!exisitingFund.auditPeriodBegin.equals(fund.auditPeriodBegin) || !exisitingFund.auditPeriodEnd.equals(fund.auditPeriodEnd) || !exisitingFund.baseCurrency.equals(fund.baseCurrency)) =&gt; {
        fundsDAO.update(fund).flatMap(res =&gt;fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt;{
          fundEngagementReportTypeSelectionWrite.clearUploadedReports(engagements.map(_.id)).flatMap(result =&gt;{
            egaWrite.cleanEGAByFundEngagementId(engagements.map(_.id))
          })
        }))
      }
      case Some(existingFund) =&gt; {
        fundsDAO.update(fund)
      }
      case _ =&gt; {
        throw new Exception(s&quot;fund  ${fund.name} doesn&#39;t exist&quot;)
      }
    }
  })
}</code></pre></dd>
</dl>
<p>Then we find in update fund, the second branch doesn&rsquo;t retrieve fund_admin_id, so this may lead the null field</p>
<p>So we need to fix the issue by add query:</p>
<dl>
  <dt>Fix one: by add query for second branch
  </dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/code/updatefix1.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def update(fund: Fund): Future[Int] = {
  fundsDAO.lookup(fund.id).flatMap(maybeFund =&gt; {
    maybeFund match {

      //if fundAdmin changed, should update fund admin id and remove fund selection types
      case Some(existingFund) if(existingFund.fundAdmin != fund.fundAdmin) =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fund.fundAdminId = Some(fundAdmin.id)
              fundsDAO.update(fund).flatMap(updateResult =&gt; {
                fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
                  fundEngagementReportTypeSelectionDAO.deleteByEngagementIds(engagements.map(_.id))
                })
              })
            }
            case _ =&gt;{
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        })
      }
      //if fund audit period or accurency changed, should clear uploaded reports and ega.
      case Some(exisitingFund) if(!exisitingFund.auditPeriodBegin.equals(fund.auditPeriodBegin) || !exisitingFund.auditPeriodEnd.equals(fund.auditPeriodEnd) || !exisitingFund.baseCurrency.equals(fund.baseCurrency)) =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fundsDAO.update(fund).flatMap(res =&gt; fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
                fundEngagementReportTypeSelectionWrite.clearUploadedReports(engagements.map(_.id)).flatMap(result =&gt; {
                  egaWrite.cleanEGAByFundEngagementId(engagements.map(_.id))
                })
              }))
            }
            case _ =&gt; {
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        })
      }
      case Some(existingFund) =&gt; {
        fundsDAO.update(fund)
      }
      case _ =&gt; {
        throw new Exception(s&quot;fund  ${fund.name} doesn&#39;t exist&quot;)
      }
    }
  })
}</code></pre></dd>
  <dt>Fix two: by add shared query
  </dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/code/updatefix2.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def update(fund: Fund): Future[Int] = {
  val newFundFuture =  fundAdminDAO.queryByFundAdmin(fund.fundAdmin).map{
    tmpOpt =&gt;tmpOpt match{
      case Some(fundAdmin)=&gt;fund.copy(fundAdminId = Some(fundAdmin.id))
      case _=&gt;fund
    }
  }
  val newFund = Await.result(newFundFuture, 1 second)

  fundsDAO.lookup(fund.id).flatMap(maybeFund =&gt; {
    maybeFund match {

      //if fundAdmin changed, should update fund admin id and remove fund selection types
      case Some(existingFund) if(existingFund.fundAdmin != fund.fundAdmin) =&gt; {
        fundsDAO.update(newFund).flatMap(updateResult =&gt; {
          fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
            fundEngagementReportTypeSelectionDAO.deleteByEngagementIds(engagements.map(_.id))
          })
        })
      }
      //if fund audit period or accurency changed, should clear uploaded reports and ega.
      case Some(exisitingFund) if(!exisitingFund.auditPeriodBegin.equals(fund.auditPeriodBegin) || !exisitingFund.auditPeriodEnd.equals(fund.auditPeriodEnd) || !exisitingFund.baseCurrency.equals(fund.baseCurrency)) =&gt; {
        fundsDAO.update(newFund).flatMap(res =&gt; fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
          fundEngagementReportTypeSelectionWrite.clearUploadedReports(engagements.map(_.id)).flatMap(result =&gt; {
            egaWrite.cleanEGAByFundEngagementId(engagements.map(_.id))
          })
        }))
      }
      case Some(existingFund) =&gt; {
        fundsDAO.update(newFund)
      }
      case _ =&gt; {
        throw new Exception(s&quot;fund  ${fund.name} doesn&#39;t exist&quot;)
      }
    }
  })
}</code></pre></dd>
</dl>
<h2><a href="#after-fix" name="after-fix" class="anchor"><span class="anchor-link"></span></a>After fix</h2>
<p>Question 1, what&rsquo;s the root cause of the issue?</p>
<ol>
  <li>
  <p>The Fund table contains redundant information of FundAdmin table</p></li>
  <li>
  <p>The update function has multiple paths, and don&rsquo;t use shared function</p></li>
  <li>
  <p>The shared function should in out of update scope.</p></li>
</ol>
<p>Question 2, how to use the single truth principle to resolve issues above? </p>
</div>
<div>
<a href="https://github.com/wherby/docs/tree/master/docs/src/main/paradox/fieldnull/index.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../database/dbservice.html" title="DB service" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
DB service
</span>
</div>
</a>
<a href="../fieldnull/code/index.html" title="Database define" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Database define
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/wherby" class="md-footer-social__link fa fa-github"></a><a href="https://wherby.github.io" class="md-footer-social__link fa fa-globe"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-43080126-2"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})});if(document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>

</body>
</html>
